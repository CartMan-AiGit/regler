# ============================================================
# ESP8285 BOILER CONTROL ‚Äî ESPHome Config v4 (–±–æ–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
# ============================================================
# –†–ê–°–®–ò–§–†–û–í–ê–ù–ù–´–ô –ø—Ä–æ—Ç–æ–∫–æ–ª —Ç–≤–µ—Ä–¥–æ—Ç–æ–ø–ª–∏–≤–Ω–æ–≥–æ –∫–æ—Ç–ª–∞.
# –î–í–£–•–ö–û–¢–õ–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê: —Ç–≤–µ—Ä–¥–æ—Ç–æ–ø (–æ—Å–Ω–æ–≤–Ω–æ–π) + —ç–ª–µ–∫—Ç—Ä–æ (—Ä–µ–∑–µ—Ä–≤).
# ESP-01S (ESP8266) –∑–∞–º–µ–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π WiFi-–º–æ–¥—É–ª—å.
#
# UART: 9600 8N1, –∫–∞–¥—Ä—ã SOH(0x01)/TYPE/STX(0x02)/DATA/ETX(0x03)
# –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: SOH + "1" + STX + "0" + %02d_value + keypair + ETX (9 –±–∞–π—Ç)
#
# ===== EEPROM –ü–ê–†–ê–ú–ï–¢–†–´ (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–ª–∞—Ç—É) =====
#   –ü–∞—Ä  –û—Ç–≤  –ö–æ–º–∞–Ω–¥–∞  –î–µ—Ñ–æ–ª—Ç  –ë–æ–µ–≤–æ–µ  –î–∏—Å–ø–ª–µ–π  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
#   [0]  E    EF=XX    65      39      tA       –ù–ê–°–û–° –í–ö–õ –ø—Ä–∏ T‚â•E (¬∞C), GPIO4
#   [1]  K    JK=XX    20      20      ‚Äî        –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ NTC: —Å–º–µ—â–µ–Ω–∏–µ = K-20
#   [3]  B    BC=XX    10      10      Pr PA    –ü–µ—Ä–µ—Ä—ã–≤ –ø—Ä–æ–¥—É–≤–∫–∏ (–º–∏–Ω)
#   [4]  L    KL=XX    30      20      dt       –í—Ä–µ–º—è —Ä–æ–∑–∂–∏–≥–∞ (–º–∏–Ω)
#   [5]  D    DE=XX    100     60      nP/On    –ú–æ—â–Ω–æ—Å—Ç—å –≤–µ–Ω—Ç. –º–∞–∫—Å (%)
#   [8]  A    AB=XX    20      20      Pr       –í—Ä–µ–º—è –ø—Ä–æ–¥—É–≤–∫–∏ (—Å–µ–∫)
#   [9]  F    FG=XX    30      39      tP       –ü–æ—Ä–æ–≥ –æ–≥–Ω—è/—Ä–æ–∑–∂–∏–≥–∞ (¬∞C), –ø–æ–ª–µ G
#   [10] C    CD=XX    60      40      Ob       –û–±–æ—Ä–æ—Ç—ã –≤–µ–Ω—Ç. –º–∏–Ω (%)
#   [7]  a    ab=XX    50      30      tE       –¢–µ–º–ø. —É–≥–∞—Å–∞–Ω–∏—è ‚Äî –ø–æ—Ä–æ–≥ –≤–µ–Ω—Ç. (¬∞C)
#   ‚ö†Ô∏è ¬´–í–û–î–ê 50¬∞C¬ª –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ Telegram ‚Äî —É—Å—Ç–∞–≤–∫–∞ –ë–û–¢–ê (de=0 –ø—Ä–∏ T‚â•50)
#   –ë–æ—Ç/–æ–±–ª–∞–∫–æ —É–ø—Ä–∞–≤–ª—è–ª–∏ de=1/de=0, —ç—Ç–æ –ù–ï EEPROM –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ—à–∏–≤–∫–∏.
#   Hi (–≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å) ‚Äî –≤ –ø—Ä–æ—à–∏–≤–∫–µ v2.2.2 –∑–∞—à–∏—Ç 1¬∞C, –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è.
#
# ===== –ê–õ–ì–û–†–ò–¢–ú (–¥–≤—É—Ö–∫–æ—Ç–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, —Ç–≤–µ—Ä–¥–æ—Ç–æ–ø + —ç–ª–µ–∫—Ç—Ä–æ) =====
#   –°–¢–ê–†–¢ (—Ä–æ–∑–∂–∏–≥):
#     1) –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –Ω–∞ D% (60%) ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–¥–¥—É–≤
#     2) –¢–∞–π–º–µ—Ä L –º–∏–Ω (20 –º–∏–Ω):
#        ‚Äî T > ab (50¬∞C) ‚Üí –≤–µ–Ω—Ç. —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ C% (40%) ‚Äî –æ–≥–æ–Ω—å –µ—Å—Ç—å
#        ‚Äî T ‚â• E (39¬∞C) ‚Üí –Ω–∞—Å–æ—Å –í–ö–õ (GPIO4=1, –≤–æ–¥–∞ –ø—Ä–æ–≥—Ä–µ–ª–∞—Å—å)
#     3) –ï—Å–ª–∏ –∑–∞ L –º–∏–Ω T < ab ‚Üí –∑–∞—Ç—É—Ö–∞–Ω–∏–µ ‚Üí –≤–µ–Ω—Ç. OFF
#   –†–ê–ë–û–¢–ê:
#     - delta = ab - T ‚Üí TRIAC –º–æ–¥—É–ª–∏—Ä—É–µ—Ç –≤–µ–Ω—Ç. –æ—Ç C% (–ø—Ä–∏ T‚âàab) –¥–æ D%
#     - –ü—Ä–æ–¥—É–≤–∫–∞: –∫–∞–∂–¥—ã–µ B –º–∏–Ω –≤–µ–Ω—Ç. MAX –Ω–∞ A —Å–µ–∫ (–¥–æ–∂–∏–≥ –≥–∞–∑–æ–≤)
#     - –ù–∞—Å–æ—Å: –ø—Ä–æ—à–∏–≤–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–∏ T‚â•E (GPIO4=HIGH)
#     - ESPHome: hi=0 –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (–º—å—é—Ç –∑—É–º–º–µ—Ä–∞, –≠–ö–û –ù–ï –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è)
#   –°–¢–û–ü (–∑–∞—Ç—É—Ö–∞–Ω–∏–µ):
#     1) T < E-2 (37¬∞C) ‚Üí GPIO4=0 ‚Üí –Ω–∞—Å–æ—Å –í–´–ö–õ (–≥–∏—Å—Ç. 2¬∞C)
#        ‚Üí —ç–ª–µ–∫—Ç—Ä–æ–∫–æ—Ç—ë–ª –±–µ—Ä—ë—Ç –Ω–∞–≥—Ä—É–∑–∫—É
#     2) T < ab (50¬∞C) ‚Üí –≤–µ–Ω—Ç. –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–¥—É—Ç—å, –µ—Å–ª–∏ L-—Ç–∞–π–º–µ—Ä ‚Üí –≤–µ–Ω—Ç. OFF
#   –ó–ê–©–ò–¢–ê: T‚â•90¬∞C ‚Üí j=1 + –¥–∏—Å–ø–ª–µ–π –º–∏–≥–∞–µ—Ç, T‚â•120¬∞C(5—Å) ‚Üí g=1 + GPIO5 –ø—É–ª—å—Å–∏—Ä—É–µ—Ç
#
# ===== –ê–í–ê–†–ò–ô–ù–ê–Ø –°–ò–°–¢–ï–ú–ê (–∑–∞—à–∏—Ç–∞ –≤ –ø—Ä–æ—à–∏–≤–∫—É, –ù–ï –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è) =====
#   90¬∞C ‚â§ T < 120¬∞C ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (j=1): –¥–∏—Å–ø–ª–µ–π –º–∏–≥–∞–µ—Ç
#   T ‚â• 120¬∞C (5 —Å–µ–∫) ‚Üí –ø–µ—Ä–µ–≥—Ä–µ–≤ (g=1): GPIO5 –ø—É–ª—å—Å–∏—Ä—É–µ—Ç (–∞–≤–∞—Ä–∏–π–Ω—ã–π –Ω–∞—Å–æ—Å)
#   –ó—É–º–º–µ—Ä: –≤—Å—Ç—Ä–æ–µ–Ω –≤ TM1637, –º—å—é—Ç–∏—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π hi=0 –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
#   –ü–æ—Ä–æ–≥–∏ 90/120¬∞C –ó–ê–®–ò–¢–´ –≤ –ø—Ä–æ—à–∏–≤–∫—É, –∏–∑–º–µ–Ω–∏—Ç—å –ù–ï–õ–¨–ó–Ø.
#
# ===== RUNTIME –ö–û–ú–ê–ù–î–´ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ EEPROM) =====
#   de=1 / de=0  ‚Üí –ú–ê–°–¢–ï–† ON/OFF –Ω–∞–≥—Ä–µ–≤–∞
#   hi=1          ‚Üí —Ç–æ–≥–≥–ª –ö–æ–º—Ñ–æ—Ä—Ç/–≠–∫–æ (–¥–µ–±–∞—É–Ω—Å 120—Å)
#
# ===== –û–¢–í–ï–¢ –ü–õ–ê–¢–´ =====
#   Runtime: a<—É—Å—Ç–∞–≤–∫–∞>bcd<—Ç–µ–º–ø>e<—Ä–µ–∂–∏–º>f<–≤–µ—Ä—Å–∏—è>g<–ø–µ—Ä–µ–≥—Ä–µ–≤>hij<–ø—Ä–µ–¥—É–ø—Ä>k<—ç–∫–æ>l
#   EEPROM:  A<p8>B<p3>C<p10>D<p5>E<p0>F<p9>G<–≥–æ—Ä–µ–Ω–∏–µ>HIJK<p1>L<p4>M
#   g = –ø–µ—Ä–µ–≥—Ä–µ–≤ (T‚â•120¬∞C, 5 —Å–µ–∫) ‚Üí GPIO5 –ø—É–ª—å—Å–∏—Ä—É–µ—Ç, –¥–∏—Å–ø–ª–µ–π –º–∏–≥–∞–µ—Ç
#   j = –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (90‚â§T<120¬∞C) ‚Üí –¥–∏—Å–ø–ª–µ–π –º–∏–≥–∞–µ—Ç
#   G = —Å—Ç–∞—Ç—É—Å –≥–æ—Ä–µ–Ω–∏—è (–ù–ï –Ω–∞—Å–æ—Å!):
#     G=0 ‚Üí –Ω–µ—Ç –≥–æ—Ä–µ–Ω–∏—è / –±–µ–∑–æ–ø–∞—Å–Ω–æ
#     G=1 ‚Üí –≥–æ—Ä–µ–Ω–∏–µ –µ—Å—Ç—å
#
# GPIO: 4=—Ä–µ–ª–µ(–ù–ê–°–û–°), 5=–∞–≤–∞—Ä–∏–π–Ω.–Ω–∞—Å–æ—Å(–ø–µ—Ä–µ–≥—Ä–µ–≤), 12=ZC(–≤—Ö–æ–¥), 15=TRIAC(–≤—ã—Ö–æ–¥)
# GPIO: 9,10=–∫–Ω–æ–ø–∫–∏(–≤—Ö–æ–¥), 14=TM1637-CLK, 16=TM1637-DIO
# LED1-LED6: –≤—Å–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ TM1637 (5-–π –±–∞–π—Ç, –±–∏—Ç—ã 0-4)
#   LED1 ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (GRID6, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–µ—Ç—Å—è)
#   LED2 ‚Äî –ù–∞—Å–æ—Å (–±–∏—Ç 4), LED3 ‚Äî –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä (–±–∏—Ç 3)
#   LED4 ‚Äî –†–æ–∑–∂–∏–≥ (–±–∏—Ç 2, –º–∏–≥–∞–µ—Ç), LED5 ‚Äî WiFi (–±–∏—Ç 1)
#   LED6 ‚Äî –ö–æ–º–Ω–∞—Ç–Ω–∞—è T (–±–∏—Ç 0) ‚Äî –≥–æ—Ä–∏—Ç –ø—Ä–∏ heartbeat='2' !
# Heartbeat TYPE2: –ø–µ—Ä–≤—ã–π –±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö = WiFi-—Å—Ç–∞—Ç—É—Å:
#   '1' ‚Üí LED5 –º–∏–≥–∞–µ—Ç 500–º—Å (–ø–æ–∏—Å–∫ WiFi / –ø–æ–¥–∫–ª—é—á—ë–Ω)
#   '3' ‚Üí LED5 –º–∏–≥–∞–µ—Ç 100–º—Å (AP mode ‚Äî –Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞!)
#   '0' ‚Üí LED5 –Ω–µ –≥–æ—Ä–∏—Ç
#   ‚ö†Ô∏è '2' ‚Üí LED6 –∑–∞–≥–æ—Ä–∞–µ—Ç—Å—è (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å!)
#   ‚ö†Ô∏è –°—á—ë—Ç—á–∏–∫ heartbeat –î–û–õ–ñ–ï–ù –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è! –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π
#      —Å—á—ë—Ç—á–∏–∫ '0' ‚Üí ESP8285 —Å—á–∏—Ç–∞–µ—Ç heartbeat –º—ë—Ä—Ç–≤—ã–º ‚Üí LED5 –≥–∞—Å–Ω–µ—Ç!
# –ö–ù–û–ü–ö–ê 4 (5 —Å–µ–∫): ESP8285 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç e=3 ‚Üí ESP-01S –≤–∫–ª—é—á–∞–µ—Ç AP
#
# ===== GPIO4 –ù–ê–°–û–° =====
#   –ù–∞—Å–æ—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ü–†–û–®–ò–í–ö–û–ô —á–µ—Ä–µ–∑ E-—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç (param[0]):
#     T ‚â• E (39¬∞C) ‚Üí GPIO4=HIGH ‚Üí –Ω–∞—Å–æ—Å –í–ö–õ
#     T < E-2 (37¬∞C) ‚Üí GPIO4=LOW ‚Üí –Ω–∞—Å–æ—Å –í–´–ö–õ (–≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å 2¬∞C)
#   ‚ö†Ô∏è E=99 –û–¢–ö–õ–Æ–ß–ê–ï–¢ –ù–ê–°–û–° (–ø–æ—Ä–æ–≥ 99¬∞C ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è)!
#   ‚ö†Ô∏è E=0 –§–û–†–°–ò–†–£–ï–¢ –ù–ê–°–û–° (–≤—Å–µ–≥–¥–∞ –í–ö–õ, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π).
#   GPIO5 = –∞–≤–∞—Ä–∏–π–Ω—ã–π –Ω–∞—Å–æ—Å –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä–µ–≤–µ (T>90¬∞C).
#   ESPHome –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞—Å–æ—Å–æ–º ‚Äî —Ç–æ–ª—å–∫–æ EEPROM –ø–∞—Ä–∞–º–µ—Ç—Ä E.
#
# ===== –≠–ö–û-–†–ï–ñ–ò–ú =====
#   –≠–ö–û (k=1) –º–µ–Ω—è–µ—Ç —Ü–µ–ª–µ–≤—É—é –≤–µ–Ω—Ç. —Å ab –Ω–∞ F+5.
#   –í–ê–ñ–ù–û: hi=1 –í–ö–õ–Æ–ß–ê–ï–¢ –≠–ö–û! hi=0 ‚Äî –ù–ï –≤–∫–ª—é—á–∞–µ—Ç.
#   –û—Ç–ø—Ä–∞–≤–ª—è–µ–º hi=0 –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É ‚Üí –º—å—é—Ç –∑—É–º–º–µ—Ä–∞ –ë–ï–ó –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≠–ö–û.
#   –ß–µ—Ä–µ–∑ 120—Å –±–µ–∑ hi=1 ‚Üí –≠–ö–û –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è (debounce).
#   –ï—Å–ª–∏ –≠–ö–û –±—ã–ª –≤–∫–ª—é—á—ë–Ω –î–û –Ω–∞—Å ‚Üí —á–µ—Ä–µ–∑ 120—Å —Å–∞–º –≤—ã–∫–ª—é—á–∏—Ç—Å—è.
# ============================================================

esphome:
  name: regler
  friendly_name: "Boiler Control"
  # SDK —Ñ—É–Ω–∫—Ü–∏–∏: wifi_set_opmode_current(), wifi_get_opmode(),
  # wifi_softap_get_config(), wifi_softap_set_config_current()
  includes:
    - wifi_setup.h
  on_boot:
    - priority: 300
      then:
        - lambda: |-
            // Read custom WiFi creds from our flash sector BEFORE ESPHome WiFi starts (250)
            BoilerWifiCreds cr;
            if (ESP.flashRead(BWIFI_ADDR, (uint32_t*)&cr, sizeof(cr))
                && cr.magic == BWIFI_MAGIC && cr.ssid[0]) {
              wifi::WiFiAP ap;
              ap.set_ssid(std::string(cr.ssid));
              ap.set_password(std::string(cr.pass));
              wifi::global_wifi_component->set_sta(ap);
            }
    - priority: -10
      then:
        - lambda: |-
            // POST /w ‚Üí save WiFi to our flash sector + reboot
            id(web_base).get_server()->on("/w", HTTP_POST,
              [](AsyncWebServerRequest *r) {
              if (r->hasParam("s", true)) {
                BoilerWifiCreds cr;
                cr.magic = BWIFI_MAGIC;
                memset(cr.ssid, 0, sizeof(cr.ssid));
                memset(cr.pass, 0, sizeof(cr.pass));
                strncpy(cr.ssid, r->getParam("s", true)->value().c_str(), 35);
                if (r->hasParam("p", true))
                  strncpy(cr.pass, r->getParam("p", true)->value().c_str(), 63);
                ESP.flashEraseSector(BWIFI_SECTOR);
                ESP.flashWrite(BWIFI_ADDR, (uint32_t*)&cr, sizeof(cr));
              } else {
                ESP.flashEraseSector(BWIFI_SECTOR);
              }
              r->send(200, "text/plain", "OK");
              id(g_restart_pending) = millis() + 2000;
            });

esp8266:
  board: esp01_1m

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  ap:
    ssid: "Boiler-AP"
    password: !secret ap_password

logger:
  level: ERROR
  baud_rate: 0

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password

# ============================================================
# WEB SERVER ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (http://IP:80)
# v1 = –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, HTML –Ω–∞ –ª–µ—Ç—É
# CDN oi.esphome.io –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –º–∏–Ω–∏ JS/CSS –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –ø—Ä–æ—à–∏–≤–∫—É
# js_include  ‚Üí gzip –≤ PROGMEM, –æ—Ç–¥–∞—ë—Ç—Å—è –∫–∞–∫ /0.js
# css_include ‚Üí gzip –≤ PROGMEM, –æ—Ç–¥–∞—ë—Ç—Å—è –∫–∞–∫ /0.css
# js_url: "/0.js" ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç <script src="/0.js"> –≤ HTML
#   (js_include —Å–∞–º –ø–æ —Å–µ–±–µ –ù–ï –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–≥ ‚Äî –±–∞–≥ ESPHome)
# POST /w ‚Äî WiFi config (save/reset)
# ============================================================
web_server_base:
  id: web_base

web_server:
  port: 80
  version: 1
  css_url: ""
  js_url: "/0.js"
  css_include: "webserver.css"
  js_include: "webserver.js"

# ============================================================
# UART ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ESP8285 –º–∞—Ç. –ø–ª–∞—Ç—ã –∫–æ—Ç–ª–∞
# ============================================================
uart:
  id: uart_boiler
  tx_pin: GPIO1
  rx_pin: GPIO3
  baud_rate: 9600
  data_bits: 8
  stop_bits: 1
  parity: NONE

# ============================================================
# GLOBALS
# ============================================================
globals:
  - id: hb_counter
    type: int
    initial_value: '0'

  - id: hb_enabled
    type: bool
    initial_value: 'true'

  - id: hb_static
    type: bool
    initial_value: 'false'

  - id: cmd_sent_ms
    type: uint32_t
    initial_value: '0'

  - id: cmd_needs_mute
    type: bool
    initial_value: 'false'

  # --- Runtime (–∏–∑ –æ—Ç–≤–µ—Ç–∞) ---
  - id: g_temp
    type: int
    initial_value: '-99'
  - id: g_mode
    type: int
    initial_value: '-1'
  - id: g_fire
    type: int
    initial_value: '-1'
  - id: g_eco
    type: int
    initial_value: '-1'
  - id: g_overheat
    type: int
    initial_value: '0'
  - id: g_warning
    type: int
    initial_value: '0'
  - id: g_setpoint
    type: int
    initial_value: '0'
  # --- EEPROM params (–∏–∑ –æ—Ç–≤–µ—Ç–∞) ---
  - id: g_E
    type: int
    initial_value: '0'
  - id: g_A
    type: int
    initial_value: '0'
  - id: g_B
    type: int
    initial_value: '0'
  - id: g_C
    type: int
    initial_value: '0'
  - id: g_D
    type: int
    initial_value: '0'
  - id: g_F
    type: int
    initial_value: '0'
  - id: g_K
    type: int
    initial_value: '0'
  - id: g_L
    type: int
    initial_value: '0'

  # --- AP mode (–∫–Ω–æ–ø–∫–∞ 4, 5 —Å–µ–∫, –∞–≤—Ç–æ-off 5–º–∏–Ω) ---
  - id: g_ap_active
    type: uint32_t
    initial_value: '0'
  # --- Deferred restart ---
  - id: g_restart_pending
    type: uint32_t
    initial_value: '0'

# ============================================================
# INTERVAL ‚Äî Heartbeat + UART Reader
# ============================================================
interval:
  # --- Heartbeat 1—Å + –º—å—é—Ç –∑—É–º–º–µ—Ä–∞ ---
  # TYPE2 heartbeat –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (watchdog —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è).
  # –ü–µ—Ä–≤—ã–π –±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö = WiFi-—Å—Ç–∞—Ç—É—Å –¥–ª—è LED5 –Ω–∞ –ø–ª–∞—Ç–µ ESP8285:
  #   '1' ‚Üí WiFi STA –ø–æ–¥–∫–ª—é—á—ë–Ω ‚Üí LED5 –º–∏–≥–∞–µ—Ç 500–º—Å
  #   '3' ‚Üí AP mode –∞–∫—Ç–∏–≤–µ–Ω   ‚Üí LED5 –º–∏–≥–∞–µ—Ç 100–º—Å (–±—ã—Å—Ç—Ä–æ)
  #   '0' ‚Üí WiFi –≤—ã–∫–ª          ‚Üí LED5 –Ω–µ –≥–æ—Ä–∏—Ç
  # ‚ö†Ô∏è –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å '2' ‚Äî —ç—Ç–æ –∑–∞–∂–∏–≥–∞–µ—Ç LED6 (–∫–æ–º–Ω–∞—Ç–Ω—ã–π –¥–∞—Ç—á–∏–∫)!
  # hi=0 –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É ‚Üí –º—å—é—Ç –∑—É–º–º–µ—Ä–∞ –ë–ï–ó –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≠–ö–û.
  # AP enforcement: ESPHome –æ—Ç–∫–ª—é—á–∞–µ—Ç AP –ø—Ä–∏ STA connected.
  #   –•–∞–∫: –≤—ã–∑—ã–≤–∞–µ–º wifi_set_opmode_current(STATIONAP_MODE=3)
  #   –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –ø–æ–∫–∞ g_ap_active > 0.
  #   AP –∞–≤—Ç–æ–æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ g_ap_timeout (5 –º–∏–Ω—É—Ç).
  - interval: 1s
    then:
      - lambda: |-
          // Deferred restart (WiFi save)
          if (id(g_restart_pending) > 0 && millis() > id(g_restart_pending)) {
            ESP.restart();
          }
          if (!id(hb_enabled)) return;
          // Auto-AP: 60—Å –±–µ–∑ WiFi ‚Üí –≤–∫–ª—é—á–∏—Ç—å AP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          static uint32_t last_sta_ok = 0;
          if (WiFi.isConnected()) {
            last_sta_ok = millis();
          } else if (id(g_ap_active) == 0 && millis() > 60000
                     && (last_sta_ok == 0 || millis() - last_sta_ok > 60000)) {
            id(g_ap_active) = millis() ? millis() : 1;
            wifi_set_opmode_current(STATIONAP_MODE);
          }
          // AP: enforce STATIONAP + auto-off 5min (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ STA –û–ö)
          if (id(g_ap_active) > 0) {
            if (WiFi.isConnected() && millis() - id(g_ap_active) > 300000) {
              id(g_ap_active) = 0;
              wifi_set_opmode_current(STATION_MODE);
            } else if (wifi_get_opmode() != STATIONAP_MODE) {
              wifi_set_opmode_current(STATIONAP_MODE);
            }
          }
          
          // === WiFi status ‚Üí LED5 –Ω–∞ –ø–ª–∞—Ç–µ ESP8285 ===
          // ESP8285 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¢–û–õ–¨–ö–û –º–∏–≥–∞–Ω–∏–µ, –Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ!
          // '1' ‚Üí LED5 –º–∏–≥–∞–µ—Ç 500–º—Å (–ø–æ–∏—Å–∫ WiFi / –ø–æ–¥–∫–ª—é—á—ë–Ω)
          // '3' ‚Üí LED5 –º–∏–≥–∞–µ—Ç 100–º—Å (AP mode ‚Äî –Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
          // '0' ‚Üí LED5 –Ω–µ –≥–æ—Ä–∏—Ç
          uint8_t wifi_status;
          if (id(g_ap_active) > 0) {
            wifi_status = '3';  // AP mode ‚Üí –±—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ 100–º—Å
          } else {
            wifi_status = '1';  // Searching / Connected ‚Üí –º–∏–≥–∞–Ω–∏–µ 500–º—Å
          }
          
          // === TYPE 2: heartbeat (connection watchdog) ===
          uint8_t cnt;
          if (id(hb_static)) {
            cnt = '0';
          } else {
            id(hb_counter) = (id(hb_counter) + 1) % 9;
            cnt = '0' + id(hb_counter);
          }
          uint8_t hb[] = {0x01, 0x32, 0x02, wifi_status, cnt, 0x03, 0x0D, 0x0A};
          id(uart_boiler).write_array(hb, sizeof(hb));
          
          // === hi=0: –º—å—é—Ç –∑—É–º–º–µ—Ä–∞ –ë–ï–ó –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≠–ö–û ===
          bool can_mute = !id(cmd_needs_mute) || (millis() - id(cmd_sent_ms) > 3000);
          if (can_mute) {
            if (id(cmd_needs_mute)) {
              id(cmd_needs_mute) = false;
              ESP_LOGW("MUTE", "Response timeout 3s ‚Äî forcing mute");
            }
            uint8_t hi[] = {0x01,0x31,0x02, 0x30,0x30,0x30, 0x68,0x69, 0x03};
            id(uart_boiler).write_array(hi, sizeof(hi));
          }
          
          if (id(hb_counter) == 0) {
            ESP_LOGD("HB", "wifi=%c ap=%lu T=%d fire=%d mode=%d eco=%d",
              (char)wifi_status, (unsigned long)id(g_ap_active),
              id(g_temp), id(g_fire), id(g_mode), id(g_eco));
          }

  # --- UART reader –∫–∞–∂–¥—ã–µ 100–º—Å ---
  - interval: 100ms
    then:
      - lambda: |-
          static int state = 0;
          static std::string type_field = "";
          static std::string data_field = "";
          static uint32_t last_byte_ms = 0;
          
          if (state != 0 && (millis() - last_byte_ms > 1000)) {
            state = 0;
          }
          
          while (id(uart_boiler).available()) {
            uint8_t byte;
            id(uart_boiler).read_byte(&byte);
            last_byte_ms = millis();
            
            if (byte == 0x01) {
              state = 1;
              type_field = "";
              data_field = "";
            }
            else if (byte == 0x02 && state == 1) {
              state = 2;
            }
            else if (byte == 0x03 && state == 2) {
              state = 0;
              
              if (type_field == "1") {
                std::string &s = data_field;
                
                auto xint = [&](const std::string &src, char key) -> int {
                  size_t pos = src.find(key);
                  if (pos == std::string::npos || pos + 1 >= src.length()) return -999;
                  std::string n = "";
                  for (size_t i = pos + 1; i < src.length(); i++) {
                    char c = src[i];
                    if ((c >= '0' && c <= '9') || (c == '-' && n.empty())) n += c;
                    else break;
                  }
                  return n.empty() ? -999 : atoi(n.c_str());
                };
                
                // Runtime
                int va = xint(s, 'a');
                int vd = xint(s, 'd');
                int ve = xint(s, 'e');
                int vg = xint(s, 'g');
                int vj = xint(s, 'j');
                int vk = xint(s, 'k');
                
                // EEPROM (–ø–æ—Å–ª–µ 'l')
                size_t l_pos = s.find('l');
                std::string up = (l_pos != std::string::npos) ? s.substr(l_pos) : s;
                int vA = xint(up, 'A');
                int vB = xint(up, 'B');
                int vC = xint(up, 'C');
                int vD = xint(up, 'D');
                int vE = xint(up, 'E');
                int vF = xint(up, 'F');
                int vG = xint(up, 'G');
                int vK = xint(up, 'K');
                int vL = xint(up, 'L');
                
                if (va != -999) id(g_setpoint) = va;
                if (vd != -999) id(g_temp) = vd;
                if (ve != -999) id(g_mode) = ve;
                if (vg != -999) id(g_overheat) = vg;
                if (vj != -999) id(g_warning) = vj;
                if (vk != -999) id(g_eco) = vk;
                if (vG != -999) id(g_fire) = vG;
                if (vE != -999) id(g_E) = vE;
                if (vA != -999) id(g_A) = vA;
                if (vB != -999) id(g_B) = vB;
                if (vC != -999) id(g_C) = vC;
                if (vD != -999) id(g_D) = vD;
                if (vF != -999) id(g_F) = vF;
                if (vK != -999) id(g_K) = vK;
                if (vL != -999) id(g_L) = vL;
                
                ESP_LOGW("BOILER", "mode=%d fire=%d warn=%d ovht=%d eco=%d temp=%d setpt=%d | A=%d B=%d C=%d D=%d E=%d F=%d K=%d L=%d",
                         ve, vG, vj, vg, vk, vd, va, vA, vB, vC, vD, vE, vF, vK, vL);
                
                // === –ö–ù–û–ü–ö–ê 4 (5 —Å–µ–∫) ‚Üí AP MODE ===
                // ESP8285 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç e=3 –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ 4.
                // –¢–æ–≥–≥–ª: –ø–µ—Ä–≤–æ–µ ‚Üí AP ON, –≤—Ç–æ—Ä–æ–µ ‚Üí AP OFF.
                // ESPHome –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç WiFi –∏ –≤—ã–∫–ª—é—á–∞–µ—Ç AP –ø—Ä–∏ STA connected.
                // –•–∞–∫: –∏—Å–ø–æ–ª—å–∑—É–µ–º ESP8266 SDK –Ω–∞–ø—Ä—è–º—É—é + enforcement –≤ heartbeat.
                if (ve == 3) {
                  if (id(g_ap_active) == 0) {
                    id(g_ap_active) = millis() ? millis() : 1;
                    wifi_set_opmode_current(STATIONAP_MODE);
                  } else {
                    id(g_ap_active) = 0;
                    wifi_set_opmode_current(STATION_MODE);
                  }
                }
                
                // Sync number sliders ‚Üê actual board EEPROM values
                if (va != -999) id(num_setpoint).publish_state(va);
                if (vD != -999) id(num_triac_duty).publish_state(vD);
                if (vA != -999) id(num_fan_min).publish_state(vA);
                if (vC != -999) id(num_max_temp).publish_state(vC);
                if (vB != -999) id(num_anticycle).publish_state(vB);
                if (vL != -999) id(num_max_run).publish_state(vL);
                if (vF != -999) id(num_fire_threshold).publish_state(vF);
                if (vK != -999) id(num_room_setpoint).publish_state(vK);
                if (vE != -999) id(num_pump_threshold).publish_state(vE);
                
                // Response-triggered mute: –æ—Ç–≤–µ—Ç = –∫–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ ‚Üí hi=0
                if (id(cmd_needs_mute)) {
                  id(cmd_needs_mute) = false;
                  uint8_t hi_m[] = {0x01,0x31,0x02, 0x30,0x30,0x30, 0x68,0x69, 0x03};
                  id(uart_boiler).write_array(hi_m, sizeof(hi_m));
                  ESP_LOGD("MUTE", ">>> hi=0 (resp-triggered, buzz=%dms)",
                    (int)(millis() - id(cmd_sent_ms)));
                }
              }
            }
            else if (state == 1) {
              type_field += (char)byte;
            }
            else if (state == 2) {
              data_field += (char)byte;
            }
          }

# ============================================================
# SENSORS ‚Äî –°—Ç–∞—Ç—É—Å –∫–æ—Ç–ª–∞
# ============================================================
sensor:
  - platform: template
    name: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã"
    id: sensor_temp
    lambda: 'return id(g_temp);'
    update_interval: 5s
    accuracy_decimals: 0
    unit_of_measurement: "¬∞C"
    icon: "mdi:thermometer"

  - platform: template
    name: "–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø. (a)"
    id: sensor_setpoint
    lambda: 'return id(g_setpoint);'
    update_interval: 5s
    accuracy_decimals: 0
    unit_of_measurement: "¬∞C"
    icon: "mdi:thermometer-check"

  - platform: template
    name: "–†–µ–∂–∏–º (e)"
    id: sensor_mode
    lambda: 'return id(g_mode);'
    update_interval: 5s
    accuracy_decimals: 0
    icon: "mdi:state-machine"

# ============================================================
# BINARY SENSORS ‚Äî –±–∏–Ω–∞—Ä–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –≤ HA)
# ============================================================
binary_sensor:
  - platform: template
    name: "–ù–∞—Å–æ—Å"
    id: bsensor_pump
    device_class: running
    lambda: |-
      int t = id(g_temp);
      int e = id(g_E);
      int m = id(g_mode);
      if (m == 0) return false;    // —Å–∏—Å—Ç–µ–º–∞ –í–´–ö–õ ‚Üí –Ω–∞—Å–æ—Å –í–´–ö–õ
      if (e == 0) return true;     // E=0 ‚Üí –Ω–∞—Å–æ—Å –≤—Å–µ–≥–¥–∞ –í–ö–õ
      if (t >= e) return true;     // T‚â•E ‚Üí GPIO4=1 ‚Üí –Ω–∞—Å–æ—Å –í–ö–õ
      return false;                // T<E ‚Üí –Ω–∞—Å–æ—Å –í–´–ö–õ
    icon: "mdi:pump"

  - platform: template
    name: "–ì–æ—Ä–µ–Ω–∏–µ"
    id: bsensor_fire
    device_class: heat
    lambda: |-
      return id(g_fire) == 1;
    icon: "mdi:fire"

  - platform: template
    name: "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ (90¬∞C+)"
    id: bsensor_warning
    device_class: heat
    lambda: |-
      return id(g_warning) == 1;
    icon: "mdi:thermometer-alert"

  - platform: template
    name: "üö® –ü–µ—Ä–µ–≥—Ä–µ–≤ (120¬∞C+)"
    id: bsensor_overheat
    device_class: problem
    lambda: |-
      return id(g_overheat) == 1;
    icon: "mdi:alert-circle"

text_sensor:
  - platform: template
    name: "STA –°—Ç–∞—Ç—É—Å –∫–æ—Ç–ª–∞"
    id: tsensor_status
    lambda: |-
      int m = id(g_mode);
      int e = id(g_eco);
      if (m == -1) return std::string("üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
      if (m == 0) return std::string("‚õî –í–´–ö–õ");
      if (m == 3) return std::string("üö® –û–®–ò–ë–ö–ê");
      std::string s = "";
      if (m == 2) s = "üî• –ù–ê–ì–†–ï–í";
      else if (m == 1) s = "‚è≥ –û–ñ–ò–î–ê–ù–ò–ï";
      else s = "‚ùì mode=" + to_string(m);
      int t = id(g_temp);
      int e_val = id(g_E);
      if (e_val > 0 && t < e_val) s += " | –ù–ê–°–û–°‚õî";
      else s += " | –ù–ê–°–û–°‚úÖ";
      if (id(g_overheat) == 1) s += " | üö®–ü–ï–†–ï–ì–†–ï–í!";
      else if (id(g_warning) == 1) s += " | ‚ö†Ô∏è90¬∞C+";
      if (e == 1) s += " | ‚ö†Ô∏è–≠–ö–û!";
      return s;
    update_interval: 3s
    icon: "mdi:fire"

# ============================================================
# –°–í–ò–¢–ß –ù–ê–ì–†–ï–í–ê ‚Äî de=1/0, –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∞—Ç—ã
# ============================================================
# –ó–£–ú–ú–ï–†: response-triggered mute. –ü–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã –∂–¥—ë–º –æ—Ç–≤–µ—Ç
# –ø–ª–∞—Ç—ã (TYPE 1 response), –∑–∞—Ç–µ–º —Å—Ä–∞–∑—É hi=0 (–º—å—é—Ç –±–µ–∑ –≠–ö–û).
# Buzz ‚âà 1 —Ü–∏–∫–ª main loop ESP8285 ‚âà 1-2—Å.
# ============================================================
switch:
  - platform: template
    name: "–ù–∞–≥—Ä–µ–≤"
    id: sw_heating
    icon: "mdi:fire"
    restore_mode: DISABLED
    lambda: 'return id(g_mode) > 0;'
    turn_on_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          uint8_t f[] = {0x01,0x31,0x02, 0x30,0x30,0x31, 0x64,0x65, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> HEATING ON (de=1)");
    turn_off_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          uint8_t f[] = {0x01,0x31,0x02, 0x30,0x30,0x30, 0x64,0x65, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> HEATING OFF (de=0)");

# ============================================================
# –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
# ============================================================
# ============================================================
# –£–°–¢–ê–í–ö–ê –¢–ï–ú–ü–ï–†–ê–¢–£–†–´ ‚Äî –ø—Ä—è–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
# ============================================================
number:
  # [7] a ‚Äî –¶–ï–õ–ï–í–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê –í–û–î–´ (¬∞C)
  #   param[7] ‚Üí EEPROM slot 0x0D, –∫–æ–º–∞–Ω–¥–∞ ab=XX
  #   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–µ–ª–µ–≤—É—é (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é) —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≤–æ–¥—ã:
  #   - T < ab ‚Üí –≤–µ–Ω—Ç. –Ω–∞ –ú–ê–ö–°–ò–ú–£–ú–ï (D%) ‚Äî –Ω–∞–¥–¥—É–≤, —Ä–∞–∑–≥–æ–Ω
  #   - T ‚âà ab ‚Üí –≤–µ–Ω—Ç. –ú–û–î–£–õ–Ø–¶–ò–Ø (C%..D%, –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  #   - T > ab ‚Üí –≤–µ–Ω—Ç. –Ω–∞ –ú–ò–ù–ò–ú–£–ú–ï (C%) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ
  #   - –ó–∞ L –º–∏–Ω T < ab ‚Üí –æ–≥–æ–Ω—å –Ω–µ —Ä–∞–∑–≥–æ—Ä–µ–ª—Å—è ‚Üí –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
  #   –ü—Ä–∏–º–µ—Ä—ã: -20¬∞C –∑–∞ –±–æ—Ä—Ç–æ–º ‚Üí ab=50, -40¬∞C ‚Üí ab=70
  - platform: template
    name: "üå° –¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞"
    id: num_setpoint
    min_value: 30
    max_value: 85
    step: 1
    initial_value: 30
    optimistic: true
    restore_value: true
    unit_of_measurement: "¬∞C"
    icon: "mdi:thermometer-check"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x61,0x62, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> ab=%d (setpoint)", v);

# ============================================================
# EEPROM –ü–ê–†–ê–ú–ï–¢–†–´ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–ª–∞—Ç—É, —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ
# ============================================================
  # [5] D ‚Äî TRIAC –º–æ—â–Ω–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞ (%)
  #   10% = –º–∏–Ω (–∑–∞–¥–µ—Ä–∂–∫–∞ 7000¬µs, –ø–æ—á—Ç–∏ –≤—ã–∫–ª)
  #   100% = –º–∞–∫—Å (–∑–∞–¥–µ—Ä–∂–∫–∞ 2000¬µs, –ø–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å)
  #   –§–æ—Ä–º—É–ª–∞: delay_¬µs = map(D, 10, 100, 7000, 2000)
  - platform: template
    name: "‚ö° FanMax –í–µ–Ω—Ç –º–∞–∫—Å"
    id: num_triac_duty
    min_value: 10
    max_value: 99
    step: 1
    initial_value: 60
    optimistic: true
    restore_value: true
    unit_of_measurement: "%"
    icon: "mdi:fan"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x44,0x45, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> DE=%d (TRIAC fan power %%)", v);

  # [8] A ‚Äî –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–≤–∫–∏ (—Å–µ–∫)
  #   –ö–∞–∂–¥—ã–µ B –º–∏–Ω –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç—Å—è MAX –Ω–∞ A —Å–µ–∫—É–Ω–¥
  #   (–¥–æ–∂–∏–≥ –≥–∞–∑–æ–≤ –≤ —Ç–æ–ø–∫–µ, –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è –∑–æ–ª—å–Ω–∏–∫–∞)
  - platform: template
    name: "üí® PurgeDur –î–ª–∏—Ç. –ø—Ä–æ–¥—É–≤"
    id: num_fan_min
    min_value: 0
    max_value: 99
    step: 1
    initial_value: 20
    optimistic: true
    restore_value: true
    unit_of_measurement: "—Å–µ–∫"
    icon: "mdi:fan-clock"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x41,0x42, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> AB=%d (purge duration sec)", v);

  # [10] C ‚Äî –ú–∏–Ω. —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç. –ø—Ä–∏ –º–æ–¥—É–ª—è—Ü–∏–∏ (%)
  #   –ö–æ–≥–¥–∞ T –±–ª–∏–∑–∫–æ –∫ —É—Å—Ç–∞–≤–∫–µ, –≤–µ–Ω—Ç. —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ C%
  #   –§–æ—Ä–º—É–ª–∞: map(C, 10, 100, max_delay, 7500¬µs)
  - platform: template
    name: "üåÄ FanMod –í–µ–Ω—Ç –º–∏–Ω –º–æ–¥—É–ª—è—Ü"
    id: num_max_temp
    min_value: 10
    max_value: 99
    step: 1
    initial_value: 40
    optimistic: true
    restore_value: true
    unit_of_measurement: "%"
    icon: "mdi:fan-speed-1"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x43,0x44, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> CD=%d (fan min modulation %%)", v);

  # [3] B ‚Äî –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–¥—É–≤–∫–∏ (–º–∏–Ω—É—Ç—ã)
  #   –ö–∞–∂–¥—ã–µ B –º–∏–Ω ‚Üí –≤–µ–Ω—Ç. MAX –Ω–∞ A —Å–µ–∫ (–¥–æ–∂–∏–≥ –≥–∞–∑–æ–≤)
  - platform: template
    name: "‚è± Purge –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–¥—É–≤"
    id: num_anticycle
    min_value: 0
    max_value: 60
    step: 1
    initial_value: 10
    optimistic: true
    restore_value: true
    unit_of_measurement: "–º–∏–Ω"
    icon: "mdi:timer-sand"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x42,0x43, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> BC=%d (purge interval min)", v);

  # [4] L ‚Äî –¢–∞–π–º–∞—É—Ç —Ä–æ–∑–∂–∏–≥–∞ (–º–∏–Ω—É—Ç—ã)
  #   –ï—Å–ª–∏ –∑–∞ L –º–∏–Ω T –Ω–µ –ø–æ–¥–Ω—è–ª–∞—Å—å –≤—ã—à–µ F¬∞C ‚Üí —Å—Ç–æ–ø (–æ–≥–æ–Ω—å –Ω–µ —Ä–∞–∑–≥–æ—Ä–µ–ª—Å—è)
  - platform: template
    name: "‚è∞ Ignition –¢–∞–π–º–∞—É—Ç —Ä–æ–∑–∂"
    id: num_max_run
    min_value: 5
    max_value: 99
    step: 1
    initial_value: 20
    optimistic: true
    restore_value: true
    unit_of_measurement: "–º–∏–Ω"
    icon: "mdi:clock-alert"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x4B,0x4C, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> KL=%d (ignition timeout min)", v);

  # [9] F ‚Äî –ü–û–†–û–ì –û–ì–ù–Ø / –†–û–ó–ñ–ò–ì–ê (¬∞C)
  #   F-—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç ¬´–æ–≥–æ–Ω—å –≥–æ—Ä–∏—Ç –∏–ª–∏ –Ω–µ—Ç¬ª:
  #   T > F+1 ‚Üí –æ–≥–æ–Ω—å –µ—Å—Ç—å (G=0), T ‚â§ F ‚Üí –æ–≥–Ω—è –Ω–µ—Ç (G=1)
  #   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
  #   1) –¢–∞–π–º–∞—É—Ç —Ä–æ–∑–∂–∏–≥–∞: –∑–∞ L –º–∏–Ω T < F+1 ‚Üí –æ–≥–æ–Ω—å –Ω–µ —Ä–∞–∑–≥–æ—Ä–µ–ª—Å—è ‚Üí —Å—Ç–æ–ø
  #   2) –ó–∞—Ç—É—Ö–∞–Ω–∏–µ: T < F ‚Üí –æ–≥–æ–Ω—å –ø–æ—Ç—É—Ö ‚Üí –≤—ã–±–µ–≥ L –º–∏–Ω ‚Üí –≤–µ–Ω—Ç OFF
  #   3) –≠–∫–æ-—Ä–µ–∂–∏–º: —Ü–µ–ª–µ–≤–∞—è –≤–µ–Ω—Ç = F+5¬∞C (–µ—Å–ª–∏ –≠–ö–û –≤–∫–ª—é—á—ë–Ω)
  #   –ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å 1¬∞C –≤—Å—Ç—Ä–æ–µ–Ω –≤ –ø—Ä–æ—à–∏–≤–∫—É
  - platform: template
    name: "üåÄ FanThr –ü–æ—Ä–æ–≥ –≤–µ–Ω—Ç"
    id: num_fire_threshold
    min_value: 10
    max_value: 80
    step: 1
    initial_value: 39
    optimistic: true
    restore_value: true
    unit_of_measurement: "¬∞C"
    icon: "mdi:fire-alert"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x46,0x47, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> FG=%d (fire/ignition threshold C)", v);

  # [1] K ‚Äî –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ NTC (¬∞C)
  #   –°–º–µ—â–µ–Ω–∏–µ = K - 20. –ü—Ä–∏ K=20 ‚Üí —Å–º–µ—â–µ–Ω–∏–µ 0¬∞C
  - platform: template
    name: "üîß TempCal –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞"
    id: num_room_setpoint
    min_value: 0
    max_value: 40
    step: 1
    initial_value: 20
    optimistic: true
    restore_value: true
    unit_of_measurement: "¬∞C"
    icon: "mdi:tune-vertical"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x4A,0x4B, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> JK=%d (NTC calibration)", v);

  # [0] E ‚Äî –ü–û–†–û–ì –ù–ê–°–û–°–ê (¬∞C) ‚Äî GPIO4
  #   T ‚â• E ‚Üí GPIO4=HIGH ‚Üí –Ω–∞—Å–æ—Å –í–ö–õ
  #   T < E-2 ‚Üí GPIO4=LOW ‚Üí –Ω–∞—Å–æ—Å –í–´–ö–õ (–≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å 2¬∞C)
  #   ‚ö†Ô∏è E=0 ‚Üí –Ω–∞—Å–æ—Å –í–°–ï–ì–î–ê –í–ö–õ (–∞–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º)
  #   ‚ö†Ô∏è E=99 ‚Üí –Ω–∞—Å–æ—Å –ù–ò–ö–û–ì–î–ê –Ω–µ –≤–∫–ª—é—á–∏—Ç—Å—è!
  - platform: template
    name: "üî• Pump –ü–æ—Ä–æ–≥ –Ω–∞—Å–æ—Å–∞"
    id: num_pump_threshold
    min_value: 0
    max_value: 99
    step: 1
    initial_value: 39
    optimistic: true
    restore_value: true
    unit_of_measurement: "¬∞C"
    icon: "mdi:pump"
    set_action:
      - lambda: |-
          id(cmd_needs_mute) = true;
          id(cmd_sent_ms) = millis();
          int v = (int)x;
          char vs[3];
          snprintf(vs, sizeof(vs), "%02d", v);
          uint8_t f[] = {0x01,0x31,0x02, 0x30,(uint8_t)vs[0],(uint8_t)vs[1], 0x45,0x46, 0x03};
          id(uart_boiler).write_array(f, sizeof(f));
          ESP_LOGW("cmd", ">>> EF=%d (pump threshold C)", v);
